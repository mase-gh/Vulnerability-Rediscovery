import csv
import sys
import datetime

# first arg is input file and second arg is output file

class values:
	def __init__(self):
		self.Dups = []
		self.DupNum = 0
		self.ID = ""
		self.ReleaseBlock = ""
		self.Component = ""
		self.Status = ""
		self.Owner = ""
		self.Summary = ""
		self.AllLabels = ""
		self.OS = ""
		self.CVE = ""
		self.Closed = ""
		self.MergedInto = ""
		self.reward_to = ""
		self.reward = ""
		self.Opened = ""
		self.Security_Severity = ""
		self.Security_Impact = ""
		self.Release = ""
		self.Security = ""
		
data_output = open(sys.argv[2], "w")
entries = {}

with open(sys.argv[1], 'rb') as csvfile:
	next(csvfile)
	reader = csv.reader(csvfile)
	for row in reader:
		if row[0] not in entries:
			entries[row[0]] = values()

		entries[row[0]].ID = row[0].replace(',','')
		entries[row[0]].DupNum = row[1].replace(',','')
		entries[row[0]].ReleaseBlock = row[2].replace(',','')
		entries[row[0]].Component = row[3].replace(',','')
		entries[row[0]].Status = row[4].replace(',','')
		entries[row[0]].Owner = row[5].replace(',','')
		entries[row[0]].Summary = row[6].replace(',','')
		entries[row[0]].AllLabels = row[7].replace(',','')
		entries[row[0]].OS = row[8].replace(',','')
		entries[row[0]].CVE = row[9].replace(',','')
		entries[row[0]].Closed = row[10].replace(',','')
		entries[row[0]].MergedInto = row[11].replace(',','')
		entries[row[0]].reward_to = row[12].replace(',','')
		entries[row[0]].reward = row[13].replace(',','')
		entries[row[0]].Opened = row[14].replace(',','')
		entries[row[0]].Security_Severity = row[15].replace(',','')
		entries[row[0]].Security_Impact = row[16].replace(',','')
		entries[row[0]].Release = row[17].replace(',','')
		entries[row[0]].Security = row[18].replace(',','')

		for date in row[19:]:
			dup = values()
			dup.Opened = date
			entries[row[0]].Dups.append(dup)


data_output.write("ID, Dup Num, ReleaseBlock, Component, Status, Owner, Summary, AllLabels, OS, CVE, Closed, MergedInto, reward_to, reward, Opened, Security_Severity, Security_Impact, Release, Security\n")
for key, value in entries.iteritems():
	data_output.write("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s" % (key, value.DupNum, value.ReleaseBlock, value.Component, value.Status, value.Owner, value.Summary, value.AllLabels, value.OS, value.CVE, value.Closed, value.MergedInto, value.reward_to, value.reward, value.Opened, value.Security_Severity, value.Security_Impact, value.Release, value.Security))

	if value.Opened:
		if value.Opened[0].isdigit():
			if value.Opened[3] == "/":
				orig_day_str = value.Opened[:7].rstrip()

			else:
				orig_day_str = value.Opened[:8].rstrip()

			orig_day = datetime.datetime.strptime(orig_day_str, '%m/%d/%y').date()
		else:
			orig_day_str = value.Opened[:11].rstrip()
			orig_day = datetime.datetime.strptime(orig_day_str, '%b %d %Y').date()

	for dup in value.Dups:
		data_output.write(",%s" % dup.Opened)

	if value.Opened:
		for dup in value.Dups:

			if dup.Opened:
				dup_day_str = dup.Opened[:11].rstrip()
				dup_day = datetime.datetime.strptime(dup_day_str, '%b %d %Y').date()
				data_output.write(",%d" % (dup_day - orig_day).days)

	data_output.write("\n")

data_output.close()