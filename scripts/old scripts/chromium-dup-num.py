import csv
import sys
import datetime

# first arg is input file and second arg is output file

class values:
	def __init__(self):
		self.Dups = []
		self.DupNum = 0
		self.ID = ""
		self.ReleaseBlock = ""
		self.Component = ""
		self.Status = ""
		self.Owner = ""
		self.Summary = ""
		self.AllLabels = ""
		self.OS = ""
		self.CVE = ""
		self.Closed = ""
		self.MergedInto = ""
		self.reward_to = ""
		self.reward = ""
		self.Opened = ""
		self.Security_Severity = ""
		self.Security_Impact = ""
		self.Release = ""
		self.Security = ""
		
data_output = open(sys.argv[2], "w")
entries = {}

with open(sys.argv[1], 'rb') as csvfile:
	next(csvfile)
	reader = csv.reader(csvfile)
	for row in reader:
		if row[3] == "Duplicate":
			if row[11] not in entries:
				entries[row[11]] = values()

			dup = values()
			dup.ID = row[0].replace(',','')
			dup.ReleaseBlock = row[1].replace(',','')
			dup.Component = row[2].replace(',','')
			dup.Status = row[3].replace(',','')
			dup.Owner = row[4].replace(',','')
			dup.Summary = row[5].replace(',','')
			dup.AllLabels = row[6].replace(',','')
			dup.OS = row[7].replace(',','')
			dup.CVE = row[8].replace(',','')
			dup.Closed = row[9].replace(',','')
			dup.MergedInto = row[11].replace(',','')
			dup.reward_to = row[12].replace(',','')
			dup.reward = row[13].replace(',','')
			dup.Opened = row[14].replace(',','')
			dup.Security_Severity = row[16].replace(',','')
			dup.Security_Impact = row[17].replace(',','')
			dup.Release = row[18].replace(',','')
			dup.Security = row[19].replace(',','')
			entries[row[11]].DupNum += 1
			entries[row[11]].Dups.append(dup)

		else:
			if row[0] not in entries:
				entries[row[0]] = values()

			entries[row[0]].ID = row[0].replace(',','')
			entries[row[0]].ReleaseBlock = row[1].replace(',','')
			entries[row[0]].Component = row[2].replace(',','')
			entries[row[0]].Status = row[3].replace(',','')
			entries[row[0]].Owner = row[4].replace(',','')
			entries[row[0]].Summary = row[5].replace(',','')
			entries[row[0]].AllLabels = row[6].replace(',','')
			entries[row[0]].OS = row[7].replace(',','')
			entries[row[0]].CVE = row[8].replace(',','')
			entries[row[0]].Closed = row[9].replace(',','')
			entries[row[0]].MergedInto = row[11].replace(',','')
			entries[row[0]].reward_to = row[12].replace(',','')
			entries[row[0]].reward = row[13].replace(',','')
			entries[row[0]].Opened = row[14].replace(',','')
			entries[row[0]].Security_Severity = row[16].replace(',','')
			entries[row[0]].Security_Impact = row[17].replace(',','')
			entries[row[0]].Release = row[18].replace(',','')
			entries[row[0]].Security = row[19].replace(',','')


data_output.write("ID, Dup Num, ReleaseBlock, Component, Status, Owner, Summary, AllLabels, OS, CVE, Closed, MergedInto, reward_to, reward, Opened, Security_Severity, Security_Impact, Release, Security\n")
for key, value in entries.iteritems():
	data_output.write("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s" % (key, value.DupNum, value.ReleaseBlock, value.Component, value.Status, value.Owner, value.Summary, value.AllLabels, value.OS, value.CVE, value.Closed, value.MergedInto, value.reward_to, value.reward, value.Opened, value.Security_Severity, value.Security_Impact, value.Release, value.Security))
	if value.Opened:
		orig_day_str = value.Opened[:11].rstrip()
		orig_day = datetime.datetime.strptime(orig_day_str, '%b %d %Y').date()

	for dup in value.Dups:
		data_output.write(",%s" % dup.Opened)

	data_output.write("\n")

data_output.close()