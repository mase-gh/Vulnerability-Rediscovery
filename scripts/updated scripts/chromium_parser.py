import csv
import sys
import datetime

class values:
	def __init__(self):
		self.Dups = []
		self.DupNum = 0
		self.ID = ""
		self.Component = ""
		self.Status = ""
		self.Summary = ""
		self.AllLabels = ""
		self.OS = ""
		self.MergedInto = ""
		self.Opened = ""
		self.Reporter = ""
		self.Security_Severity = ""
		self.Security_Impact = ""
		
data_output = open(sys.argv[2], "w")
entries = {}

with open(sys.argv[1], 'rb') as csvfile:
	next(csvfile)
	reader = csv.reader(csvfile)
	for row in reader:
		if row[6]:
			if row[6] not in entries:
				entries[row[6]] = values()

				dup = values()
				dup.ID = row[0].replace(',','')
				dup.Component = row[1].replace(',','')
				dup.Status = row[2].replace(',','')
				dup.Summary = row[3].replace(',','')
				dup.AllLabels = row[4].replace(',','')
				dup.OS = row[5].replace(',','')
				dup.MergedInto = row[6].replace(',','')
				dup.Opened = row[7].replace(',','')
				dup.Reporter = row[9].replace(',','')
				dup.Security_Severity = row[10].replace(',','')
				dup.Security_Impact = row[11].replace(',','')
				entries[row[6]].DupNum += 1
				entries[row[6]].Dups.append(dup)

			else:
				if entries[row[6]].Reporter != row[9].replace(',',''):
					for value in entries[row[6]].Dups:
						if value.Reporter == row[9].replace(',',''):
							entries[row[6]].Dups.remove(value)
							entries[row[6]].DupNum -= 1

					dup = values()
					dup.ID = row[0].replace(',','')
					dup.Component = row[1].replace(',','')
					dup.Status = row[2].replace(',','')
					dup.Summary = row[3].replace(',','')
					dup.AllLabels = row[4].replace(',','')
					dup.OS = row[5].replace(',','')
					dup.MergedInto = row[6].replace(',','')
					dup.Opened = row[7].replace(',','')
					dup.Reporter = row[9].replace(',','')
					dup.Security_Severity = row[10].replace(',','')
					dup.Security_Impact = row[11].replace(',','')
					entries[row[6]].DupNum += 1
					entries[row[6]].Dups.append(dup)

			if row[0] not in entries:
				entries[row[0]] = values()

			else:
				for value in entries[row[0]].Dups:
					if value.Reporter == row[9].replace(',',''):
						entries[row[0]].Dups.remove(value)
						entries[row[0]].DupNum -= 1

			entries[row[0]].ID = row[0].replace(',','')
			entries[row[0]].Component = row[1].replace(',','')
			entries[row[0]].Status = row[2].replace(',','')
			entries[row[0]].Summary = row[3].replace(',','')
			entries[row[0]].AllLabels = row[4].replace(',','')
			entries[row[0]].OS = row[5].replace(',','')
			entries[row[0]].MergedInto = row[6].replace(',','')
			entries[row[0]].Opened = row[7].replace(',','')
			entries[row[0]].Reporter = row[9].replace(',','')
			entries[row[0]].Security_Severity = row[10].replace(',','')
			entries[row[0]].Security_Impact = row[11].replace(',','')

		else:
			if row[0] not in entries:
				entries[row[0]] = values()

			else:
				for value in entries[row[0]].Dups:
					if value.Reporter == row[9].replace(',',''):
						entries[row[0]].Dups.remove(value)
						entries[row[0]].DupNum -= 1

			entries[row[0]].ID = row[0].replace(',','')
			entries[row[0]].Component = row[1].replace(',','')
			entries[row[0]].Status = row[2].replace(',','')
			entries[row[0]].Summary = row[3].replace(',','')
			entries[row[0]].AllLabels = row[4].replace(',','')
			entries[row[0]].OS = row[5].replace(',','')
			entries[row[0]].MergedInto = row[6].replace(',','')
			entries[row[0]].Opened = row[7].replace(',','')
			entries[row[0]].Reporter = row[9].replace(',','')
			entries[row[0]].Security_Severity = row[10].replace(',','')
			entries[row[0]].Security_Impact = row[11].replace(',','')

# Now that we have a dictionary, we need to check for transitivity

flag = 1

while flag != 0:

	flag = 0
	for key, value in entries.iteritems():
		if value.MergedInto and value.DupNum > 0:
			for duplicate in value.Dups:
				if duplicate.Reporter != entries[value.MergedInto].Reporter:
					for duplicateTwo in entries[value.MergedInto].Dups:
						if duplicate.Reporter == duplicateTwo.Reporter:
							entries[value.MergedInto].Dups.remove(duplicateTwo)
							entries[value.MergedInto].DupNum -= 1
					entries[value.MergedInto].Dups.append(duplicate)
					entries[value.MergedInto].DupNum += 1
			value.Dups[:] = []
			value.DupNum = 0	
			flag = 1


for key, value in entries.items():
	if value.Security_Impact != "Stable":
		del entries[key]

for key, value in entries.items():
	if value.MergedInto in entries:
		del entries[key]

data_output.write("ID, Dup Num, Component, Status, Summary, AllLabels, OS, MergedInto, Opened, Reporter, Security_Severity, Security_Impact\n")

for key, value in entries.iteritems():
	data_output.write("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s" % (key, value.DupNum, value.Component, value.Status,  value.Summary, value.AllLabels, value.OS, value.MergedInto, value.Opened, value.Reporter, value.Security_Severity, value.Security_Impact))

	for dup in value.Dups:
		data_output.write(",%s" % dup.ID)
		data_output.write(",Merged into %s" % dup.MergedInto)
		data_output.write(",%s" % dup.Opened)
		data_output.write(",%s" % dup.Reporter)

	data_output.write("\n")

data_output.close()