import json
import os
import sys
from datetime import date

# first arg is the vendor file and second arg is the directory of the json files

class values:
	def __init__(self):
		self.keywords = []
		self.dates = []

dc = "DateCreated"

with open(sys.argv[1], 'rb') as f:
	vendor_lst = f.readlines()
	vendor_lst = [x.strip() for x in vendor_lst] 

for vendor in vendor_lst:
	src = sys.argv[2]
	data_output = open("%s.csv" % vendor, "w")
	entries = {}

	for file in os.listdir(src):
	    if file.endswith(".json"):
			with open(os.path.join(src, file)) as current_file:
				data = json.load(current_file)

				try:
					if data["CVEIDs"]:
						if vendor.lower() in (name.lower() for name in data["Keywords"]):
							if data["CVEIDs"] not in entries:
								entries[data["CVEIDs"]] = values()

							for item in data["Keywords"]:
								if item not in entries[data["CVEIDs"]].keywords:
									entries[data["CVEIDs"]].keywords.append(item)

							if data[dc]:
								entries[data["CVEIDs"]].dates.append(date(int(data[dc][:4]), int(data[dc][5:7]), int(data[dc][8:10])))

				except:
					pass

	data_output.write("CVE-ID,Vendor,Product,Bug Type,Orig Vuln Date,Dup Vuln Date\n")

	for key, value in entries.iteritems():
		data_output.write("%s," % key)
		data_output.write("%s," % vendor)

		try:
			data_output.write("%s," % value.keywords[1])
			if len(value.keywords) > 3:
				data_output.write("%s - %s," % (value.keywords[2], value.keywords[3]))
			elif len(value.keywords) > 2:
				data_output.write("%s," % value.keywords[2])
			else:
				data_output.write(" ,")

		except:
			pass

		for item in sorted(value.dates):
			data_output.write("%s," % item)

		data_output.write("\n , , , ,")
		for item in sorted(value.dates):
			data_output.write("%d," % (item - sorted(value.dates)[0]).days)

		data_output.write('\n')

	data_output.close()